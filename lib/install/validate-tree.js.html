<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/install/validate-tree.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">lib/install</a> validate-tree.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">92.59% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>50/54</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">88.89% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>16/18</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>9/9</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">94.12% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>48/51</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">278x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">2588x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2588x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2588x</span>
<span class="cline-any cline-yes">2588x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-yes">10x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">682x</span>
<span class="cline-any cline-yes">682x</span>
<span class="cline-any cline-yes">682x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-yes">65x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">225x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">'use strict'
var path = require('path')
var validate = require('aproba')
var asyncMap = require('slide').asyncMap
var chain = require('slide').chain
var npmInstallChecks = require('npm-install-checks')
var checkGit = npmInstallChecks.checkGit
var clone = require('lodash.clonedeep')
var normalizePackageData = require('normalize-package-data')
var npm = require('../npm.js')
var andFinishTracker = require('./and-finish-tracker.js')
var flattenTree = require('./flatten-tree.js')
var validateAllPeerDeps = require('./deps.js').validateAllPeerDeps
var packageId = require('../utils/package-id.js')
&nbsp;
module.exports = function (idealTree, log, next) {
  validate('OOF', arguments)
  var moduleMap = flattenTree(idealTree)
  var modules = Object.keys(moduleMap).map(function (name) { return moduleMap[name] })
&nbsp;
  chain([
    [asyncMap, modules, function (mod, done) {
      chain([
        mod.parent &amp;&amp; !mod.isLink &amp;&amp; [checkGit, mod.realpath],
        [checkErrors, mod, idealTree]
      ], done)
    }],
    [thenValidateAllPeerDeps, idealTree],
    [thenCheckTop, idealTree],
    [thenCheckDuplicateDeps, idealTree]
  ], andFinishTracker(log, next))
}
&nbsp;
function checkErrors (mod, idealTree, next) {
  if (mod.error &amp;&amp; (mod.parent || path.resolve(npm.globalDir, '..') !== mod.path)) idealTree.warnings.push(mod.error)
  next()
}
&nbsp;
function thenValidateAllPeerDeps (idealTree, next) {
  validate('OF', arguments)
  validateAllPeerDeps(idealTree, function (tree, pkgname, version) {
    var warn = new Error(packageId(tree) + ' requires a peer of ' + pkgname + '@' +
      version + ' but none was installed.')
    warn.code = 'EPEERINVALID'
    idealTree.warnings.push(warn)
  })
  next()
}
&nbsp;
function thenCheckTop (idealTree, next) {
  validate('OF', arguments)
  <span class="missing-if-branch" title="if path not taken" >I</span>if (idealTree.package.error) <span class="cstat-no" title="statement not covered" >return next()</span>
&nbsp;
  // FIXME: when we replace read-package-json with something less magic,
  // this should done elsewhere.
  // As it is, the package has already been normalized and thus some
  // errors are suppressed.
  var pkg = clone(idealTree.package)
  try {
    normalizePackageData(pkg, function (warn) {
      var warnObj = new Error(packageId(idealTree) + ' ' + warn)
      warnObj.code = 'EPACKAGEJSON'
      idealTree.warnings.push(warnObj)
    }, false)
  } catch (er) {
    er.code = 'EPACKAGEJSON'
    idealTree.warnings.push(er)
  }
&nbsp;
  var nodeVersion = npm.config.get('node-version')
  <span class="missing-if-branch" title="if path not taken" >I</span>if (/-/.test(nodeVersion)) {
    // if this is a prerelease nodeâ€¦
    var warnObj = <span class="cstat-no" title="statement not covered" >new Error('You are using a pre-release version of node and things may not work as expected')</span>
<span class="cstat-no" title="statement not covered" >    warnObj.code = 'ENODEPRE'</span>
<span class="cstat-no" title="statement not covered" >    idealTree.warnings.push(warnObj)</span>
  }
&nbsp;
  next()
}
&nbsp;
// check for deps duplciated between devdeps and regular deps
function thenCheckDuplicateDeps (idealTree, next) {
  var deps = idealTree.package.dependencies || {}
  var devDeps = idealTree.package.devDependencies || {}
&nbsp;
  for (var pkg in devDeps) {
    if (pkg in deps) {
      var warnObj = new Error('The package ' + pkg + ' is included as both a dev and production dependency.')
      warnObj.code = 'EDUPLICATEDEP'
      idealTree.warnings.push(warnObj)
    }
  }
&nbsp;
  next()
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Mar 20 2017 15:16:34 GMT-0700 (PDT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
