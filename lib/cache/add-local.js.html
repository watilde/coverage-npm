<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for lib/cache/add-local.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">lib/cache</a> add-local.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">82.76% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>72/87</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">75% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>45/60</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">100% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/11</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">86.25% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>69/80</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154</td><td class="line-coverage quiet"><span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">400x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205x</span>
<span class="cline-any cline-yes">205x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">204x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">204x</span>
<span class="cline-any cline-yes">202x</span>
<span class="cline-any cline-yes">202x</span>
<span class="cline-any cline-yes">202x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">204x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">205x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">169x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">169x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">27x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">196x</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">194x</span>
<span class="cline-any cline-yes">194x</span>
<span class="cline-any cline-yes">193x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-yes">195x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var assert = require('assert')
var path = require('path')
var mkdir = require('mkdirp')
var chownr = require('chownr')
var pathIsInside = require('path-is-inside')
var readJson = require('read-package-json')
var log = require('npmlog')
var npm = require('../npm.js')
var tar = require('../utils/tar.js')
var deprCheck = require('../utils/depr-check.js')
var prepublishWarning = require('../utils/warn-deprecated.js')('prepublish-on-install')
var getCacheStat = require('./get-stat.js')
var cachedPackageRoot = require('./cached-package-root.js')
var addLocalTarball = require('./add-local-tarball.js')
var sha = require('sha')
var inflight = require('inflight')
var lifecycle = require('../utils/lifecycle.js')
var iferr = require('iferr')
var chain = require('slide').chain
&nbsp;
module.exports = addLocal
&nbsp;
function addLocal (p, pkgData, cb_) {
  assert(typeof p === 'object', 'must have spec info')
  assert(typeof cb_ === 'function', 'must have callback')
&nbsp;
  pkgData = pkgData || {}
&nbsp;
  function cb (er, data) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (er) {
<span class="cstat-no" title="statement not covered" >      log.error('addLocal', 'Could not install %s', p.spec)</span>
<span class="cstat-no" title="statement not covered" >      return cb_(er)</span>
    }
    if (data &amp;&amp; !data._fromHosted) {
      data._from = path.relative(npm.prefix, p.spec) || '.'
      var resolved = path.relative(npm.prefix, p.spec)
      if (resolved) data._resolved = 'file:' + resolved
    }
    return cb_(er, data)
  }
&nbsp;
  if (p.type === 'directory') {
    addLocalDirectory(p.spec, pkgData, null, cb)
  } else {
    addLocalTarball(p.spec, pkgData, null, cb)
  }
}
&nbsp;
// At this point, if shasum is set, it's something that we've already
// read and checked.  Just stashing it in the data at this point.
function addLocalDirectory (p, pkgData, shasum, cb) {
  assert(pkgData, 'must pass package data')
  assert(typeof cb === 'function', 'must have callback')
&nbsp;
  // if it's a folder, then read the package.json,
  // tar it to the proper place, and add the cache tar
  <span class="missing-if-branch" title="if path not taken" >I</span>if (pathIsInside(p, npm.cache)) {
<span class="cstat-no" title="statement not covered" >    return cb(new Error(</span>
    'Adding a cache directory to the cache will make the world implode.'
    ))
  }
&nbsp;
  readJson(path.join(p, 'package.json'), false, function (er, data) {
    <span class="missing-if-branch" title="if path not taken" >I</span>if (er) <span class="cstat-no" title="statement not covered" >return cb(er)</span>
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!data.name) {
<span class="cstat-no" title="statement not covered" >      return cb(new Error('No name provided in package.json'))</span>
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (pkgData.name &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >pkgData.name !== data.name)</span> {
<span class="cstat-no" title="statement not covered" >      return cb(new Error(</span>
        'Invalid package: expected ' + pkgData.name + ' but found ' + data.name
      ))
    }
&nbsp;
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!data.version) {
<span class="cstat-no" title="statement not covered" >      return cb(new Error('No version provided in package.json'))</span>
    } else <span class="missing-if-branch" title="if path not taken" >I</span>if (pkgData.version &amp;&amp; <span class="branch-1 cbranch-no" title="branch not covered" >pkgData.version !== data.version)</span> {
<span class="cstat-no" title="statement not covered" >      return cb(new Error(</span>
        'Invalid package: expected ' + pkgData.name + '@' + pkgData.version +
          ' but found ' + data.name + '@' + data.version
      ))
    }
&nbsp;
    deprCheck(data)
&nbsp;
    // pack to {cache}/name/ver/package.tgz
    var root = cachedPackageRoot(data)
    var tgz = path.resolve(root, 'package.tgz')
    var pj = path.resolve(root, 'package/package.json')
&nbsp;
    var wrapped = inflight(tgz, next)
    <span class="missing-if-branch" title="if path not taken" >I</span>if (!wrapped) <span class="cstat-no" title="statement not covered" >return log.verbose('addLocalDirectory', tgz, 'already in flight; waiting')</span>
    log.verbose('addLocalDirectory', tgz, 'not in flight; packing')
&nbsp;
    getCacheStat(function (er, cs) {
      mkdir(path.dirname(pj), function (er, made) {
        <span class="missing-if-branch" title="if path not taken" >I</span>if (er) <span class="cstat-no" title="statement not covered" >return wrapped(er)</span>
        var doPrePublish = !pathIsInside(p, npm.tmp)
        if (doPrePublish) {
          // TODO: for `npm@5`, change the behavior and remove this warning.
          // see https://github.com/npm/npm/issues/10074 for details
          if (data &amp;&amp; data.scripts &amp;&amp; data.scripts.prepublish) {
            prepublishWarning([
              'As of npm@5, `prepublish` scripts will run only for `npm publish`.',
              '(In npm@4 and previous versions, it also runs for `npm install`.)',
              'See the deprecation note in `npm help scripts` for more information.'
            ])
          }
&nbsp;
          chain(
            [
              [lifecycle, data, 'prepublish', p],
              [lifecycle, data, 'prepare', p]
            ],
            iferr(wrapped, thenPack)
          )
        } else {
          thenPack()
        }
        function thenPack () {
          tar.pack(tgz, p, data, function (er) {
            <span class="missing-if-branch" title="if path not taken" >I</span>if (er) {
<span class="cstat-no" title="statement not covered" >              log.error('addLocalDirectory', 'Could not pack', p, 'to', tgz)</span>
<span class="cstat-no" title="statement not covered" >              return wrapped(er)</span>
            }
&nbsp;
            if (!cs || isNaN(cs.uid) || isNaN(cs.gid)) return wrapped()
&nbsp;
            chownr(made || tgz, cs.uid, cs.gid, function (er) {
              if (er &amp;&amp; er.code === 'ENOENT') return wrapped()
              wrapped(er)
            })
          })
        }
      })
    })
&nbsp;
    function next (er) {
      <span class="missing-if-branch" title="if path not taken" >I</span>if (er) <span class="cstat-no" title="statement not covered" >return cb(er)</span>
      // if we have the shasum already, just add it
      <span class="missing-if-branch" title="if path not taken" >I</span>if (shasum) {
<span class="cstat-no" title="statement not covered" >        return addLocalTarball(tgz, data, shasum, cb)</span>
      } else {
        sha.get(tgz, function (er, shasum) {
          <span class="missing-if-branch" title="if path not taken" >I</span>if (er) {
<span class="cstat-no" title="statement not covered" >            return cb(er)</span>
          }
          data._shasum = shasum
          return addLocalTarball(tgz, data, shasum, cb)
        })
      }
    }
  })
}
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Mon Mar 20 2017 15:16:34 GMT-0700 (PDT)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
